{% extends "layout.html" %}

{% block content %}

<script type="text/javascript">
    $(document).ready(function () {
        execAjax = (uri, callback) => {
            let url = $(location).attr('href').split("/");
            $.ajax({
                type: "POST",
                url: url[url.length-1] + "/" + uri,
                success: callback
            });
        };

        displayResults = (selector, results) => { $(selector).html(results); };

        error_messages = []
        displayError = (message) => {
            error_messages.push(message)
            html_messages = error_messages.map((m) => {
                return '<div class="alert alert-danger" role="alert">' + m + '</div>';
            }).join('');
            displayResults('#error', html_messages)
        };

        displayScanResults = (results, av_count=0, infected_count=0, icon='') => { 
            displayResults('#scan_results', results); 
            displayResults('#av_count', av_count);
            displayResults('#infected_count', infected_count);
            displayResults('#scan_result_icon', icon);
        };
        displayFileInfo = (results) => { displayResults('#file_info', results) };
        displayStrings = (results, count) => { 
            displayResults('#strings', results); 
            displayResults('#string_total', '(' + count + ')'); 
        };

        getDetection = () => execAjax("detection", (response) => {
            response_json = jQuery.parseJSON(response)
            if (response_json.status === 'error'){
                displayError('[ScanResult]: ' + response_json.error_message);
                displayScanResults('');
            } else if (response_json.status === 'success'){
                displayScanResults(
                    response_json.result.table_html_scan_results, 
                    response_json.result.av_count, 
                    response_json.result.infected_count, 
                    response_json.result.icon
                );
            }
        });

        getFileInfo = () => execAjax("info", (response) =>  {
            response_json = jQuery.parseJSON(response)
            if (response_json.status === 'error'){
                displayError('[FileInfo]: ' + response_json.error_message);
                displayFileInfo('');
            } else if (response_json.status === 'success'){
                displayFileInfo(response_json.result.table_html_file_info);
            }
        });

        getStrings = () => execAjax("strings", (response) =>  {
            response_json = jQuery.parseJSON(response)
            if (response_json.status === 'error'){
                displayError('[Strings]: ' + response_json.error_message);
                displayStrings('');
            } else if (response_json.status === 'success'){
                displayStrings(response_json.result.table_html_strings, response_json.result.count);
            }
        });

        getDetection();
        getFileInfo();
        getStrings();
    })
</script>

<div class="row d-flex justify-content-center mt-100">
    <div class="col-md-8">
        <div id="error"></div>
        <div class="card">
            <div class="card-header">
                <h5>File info</h5>
            </div>
            <div class="card-block">
                <div id="file_info">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Scanning...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h5>AV Engine Detections (<span id="infected_count">0</span>/<span id="av_count">0</span>) <span id="scan_result_icon"></span></h5>
            </div>
            <div class="card-block">
                <div id="scan_results">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Scanning...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <h5>Strings <span id="string_total"></span></h5>
            </div>
            <div class="card-block xx-small">
                <div id="strings" class="table-wrapper-scroll-y strings-scrollbar">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Scanning...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock%}